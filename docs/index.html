<!DOCTYPE html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

    <script src="aws-cognito-sdk.min.js"></script>
    <script src="amazon-cognito-identity.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.16.0.min.js"></script>
    <script src="base58.js"></script>
    <script src="flickr.js"></script>
    <meta charset="UTF-8">
    <title>Rekognition</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="row">
            <div class="col-md-6">
                <a class="navbar-brand" href="#">Face detection in Flickr albums and groups</a>
            </div>
            <div class="col-md-6">
                        <ul class="pager">
                            <li id="prev" class="previous"><a href="javascript:prevMatch();">Previous</a></li>
                            <li id="next" class="next"><a href="javascript:nextMatch();">Next</a></li>
                        </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row" id="infos">
            <div class="col-md-6">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <span class="btn-group">
                                <input type="file" name="fileToUpload" id="fileToUpload" accept="image/*">
                        </span>
                        <span id="quality" class="pull-right">
                            <span class="label label-default">
                                Brightness <span id="brightness" class="badge"></span>
                            </span>

                            <span class="label label-default">
                                Sharpness <span id="sharpness" class="badge"></span>
                            </span>
                        </span>
                    </div>
                    <div class="panel-body img-cont">
                        <img id="img1" />
                        <div class="box" id="box1"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <span>Match <input type="number" maxlength="4" id="curMatch" /> of <span id="totalMatches"></span></span>
                        <span id="similarity" class="pull-right">
                            <span class="label label-default">
                                Similarity <span id="simil" class="badge"></span>
                            </span>
                        </span>
                    </div>
                    <div class="panel-body img-cont">
                        <div class="jumbotron">
                            <h1>Welcome to the face detector</h1>
                            <p>This page allows to search for detected faces in a set of historic pictures scanned on Flickr.</p>
                            <p id="message">Start by uploading a picture.</p>
                            <div id="loader"></div>
                        </div>
                        <img id="img2" />
                        <div class="box" id="box2"></div>
                        <div id="description">
                            <hr />
                            <a href="#" target="_blank"><h3></h3></a>
                            <p></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
  var matches = [];
  var curMatch = 0;

  $('#fileToUpload').change(function() {
      ProcessImage();
  });

  $('#curMatch').change(function() {
      curMatch = parseInt($('#curMatch').val()) - 1;
      dispMatch();
  });

  function DetectFaces() {
    AWS.region = "eu-west-1";
    var rekognition = new AWS.Rekognition();
    var params = {
      Image: {
        Bytes: imageBytes
      }
    };
    $('#box1').hide();
    $('#quality').hide();
    $('#img2').attr('src', '');
    $('#box2').hide();
    $('#similarity').hide();
    $('#totalMatches').text(0);
    $('#curMatch').val(0);
    $('#description').hide();
    $('.jumbotron').show();

    $('#message').text('Detecting faces');
    $('#loader').show();
    rekognition.detectFaces(params, function (err, data) {
      if (err) console.log(err, err.stack); // an error occurred
      else {
        console.log(data);
        var details = data.FaceDetails[0];
        var box = details.BoundingBox;
        imgE = $("#img1");
        // 15px padding
        $('#box1').css({top: imgE.height()*box.Top+15, left: imgE.width()*box.Left+15, width: imgE.width()*box.Width, height: imgE.height()*box.Height});
        $('#box1').show();


        $('#brightness').text(Number.parseFloat(details.Quality.Brightness).toPrecision(4)+'%');
        colorInfo('#brightness', details.Quality.Brightness, 90, 70);
        $('#sharpness').text(Number.parseFloat(details.Quality.Sharpness).toPrecision(4)+'%');
        colorInfo('#sharpness', details.Quality.Sharpness, 90, 70);
        $('#quality').show();

        if (match.Similarity > 99) {
            $('#simil').css({color: 'green'});
        } else if (match.Similarity > 90) {
            $('#simil').css({color: 'orange'});
        } else {
            $('#simil').css({color: 'red'});
        }
      }
    });
    var collection = 'flickr'
    var params = {
      CollectionId: collection,
      FaceMatchThreshold: 80,
      Image: {
        Bytes: imageBytes
      }
    };
    rekognition.searchFacesByImage(params, function (err, data) {
      if (err) console.log(err, err.stack); // an error occurred
      else {
        console.log(data);
        matches = data.FaceMatches;
        if (matches.length == 0) {
            $('#message').text("No matches found");
            $('#loader').hide();
        } else {
            $('.jumbotron').hide();
            curMatch = 0;
            dispMatch();
        }
      }
    });
  }

  function colorInfo(elem, val, green, orange) {
    if (val > green) {
        $(elem).css({color: 'green'});
    } else if (val > orange) {
        $(elem).css({color: 'orange'});
    } else {
        $(elem).css({color: 'red'});
    }
  }

  function prevMatch() {
    curMatch -= 1;
    dispMatch();
  }

  function nextMatch() {
    curMatch += 1;
    dispMatch();
  }

  function dispMatch() {
        $('#totalMatches').text(matches.length);
        $('#curMatch').val(curMatch+1);

        if (curMatch == 0) {
            $('#prev').hide();
        } else {
            $('#prev').show();
        }

        if (curMatch == matches.length-1 || matches.length == 0) {
            $('#next').hide();
        } else {
            $('#next').show();
        }

        var match = matches[curMatch];
        var img = match.Face.ExternalImageId;
        var bits = img.split(':');
        var imgE = $('#img2');
        imgE.attr('src', "http://farm"+bits[1]+".staticflickr.com/"+bits[2]+"/"+bits[3]+"_"+bits[4]+"_b.jpg");
        var url = "https://flic.kr/p/"+base58.encode(parseInt(bits[3]));
        $('#simil').text(Number.parseFloat(match.Similarity).toPrecision(4)+'%');
        colorInfo('#simil', match.Similarity, 99, 90);
        $('#similarity').show();

        // Flickr title and description
        var flickrApiKey = '686e331b830f5e61da5fc08906a328fa';
        var flickr = new Flickr(flickrApiKey);
        flickr.photos.getInfo(bits[3], function(response) {
            console.log(response);
            var title = response.photo.title._content;
            var description = response.photo.description._content;
            $('#description a').attr('href', url);
            $('#description a h3').text(title);
            $('#description p').html(description);
            $('#description').show();
        });


        var box = match.Face.BoundingBox;
        imgE.on('load', function() {
          // 15px padding
          $('#box2').css({top: imgE.height()*box.Top+15, left: imgE.width()*box.Left+15, width: imgE.width()*box.Width, height: imgE.height()*box.Height});
          $('#box2').show();
        });
  }

  var imageBytes;

  //Loads selected image and unencodes image bytes for Rekognition DetectFaces API
  function ProcessImage() {
    AnonLog();
    var control = document.getElementById("fileToUpload");
    var file = control.files[0];
    if(file.size > 5242880){
       alert("File is too big (5MB max)!");
       return;
    };

    // Load base64 encoded image
    var reader = new FileReader();
    reader.onload = (function (theFile) {
      return function (e) {
        //var img = document.createElement('img');
        var img = document.getElementById("img1");
        var image = null;
        img.src = e.target.result;
        var jpg = true;
        try {
          image = atob(e.target.result.split("data:image/jpeg;base64,")[1]);

        } catch (e) {
          jpg = false;
        }
        if (jpg == false) {
          try {
            image = atob(e.target.result.split("data:image/png;base64,")[1]);
          } catch (e) {
            alert("Not an image file Rekognition can process");
            return;
          }
        }
        //unencode image bytes for Rekognition DetectFaces API
        var length = image.length;
        imageBytes = new ArrayBuffer(length);
        var ua = new Uint8Array(imageBytes);
        for (var i = 0; i < length; i++) {
          ua[i] = image.charCodeAt(i);
        }
        //Call Rekognition
        DetectFaces();
      };
    })(file);
    reader.readAsDataURL(file);
  }
  //Provides anonymous log on to AWS services
  function AnonLog() {

    // Configure the credentials provider to use your identity pool
    AWS.config.region = 'eu-west-1'; // Region
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: 'eu-west-1:99b93f57-2e55-43c2-a577-71a64c5031a4',
    });
    // Make the call to obtain credentials
    AWS.config.credentials.get(function () {
      // Credentials will be available when this function is called.
      var accessKeyId = AWS.config.credentials.accessKeyId;
      var secretAccessKey = AWS.config.credentials.secretAccessKey;
      var sessionToken = AWS.config.credentials.sessionToken;
    });
  }
</script>
</html>
